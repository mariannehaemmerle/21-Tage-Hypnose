import React, { useEffect, useMemo, useRef, useState } from "react"; import { motion } from "framer-motion"; import { CheckCircle2, Upload, Trash2, File as FileIcon, Download, PlayCircle, Save, Import, RefreshCw, Search } from "lucide-react"; import { Card, CardContent } from "@/components/ui/card"; import { Button } from "@/components/ui/button"; import { Input } from "@/components/ui/input"; import { Textarea } from "@/components/ui/textarea"; import { Progress } from "@/components/ui/progress"; import * as idb from "idb-keyval";

/**

21-Tage-Journal â€“ Client-seitige MVP-App

Features:

21 Tageskarten mit: YouTube-Video, Notizen, Erledigt-Checkbox


Dateiupload pro Tag (Speicherung in IndexedDB, Metadaten in localStorage)


Fortschrittsbalken & Streak


Suche/Filter nach Textinhalten


Export/Import der Daten als JSON (inkl. Dateien â€“ Base64, optional)


Reset-Funktion


Hinweis: Diese MVP-Version lÃ¤uft komplett lokal im Browser.

FÃ¼r Mehrbenutzer, Login & Cloud-Sync spÃ¤ter z.B. Supabase/Firebase einbauen. */


const DAYS = 21; const LS_KEY = "journal21:data:v1"; const LS_META = "journal21:filesMeta:v1"; // { [day]: FileMeta[] }

function loadJSON(key, fallback) { try { const raw = localStorage.getItem(key); if (!raw) return fallback; return JSON.parse(raw); } catch (e) { return fallback; } }

function saveJSON(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

function extractYouTubeId(url) { if (!url) return ""; try { const u = new URL(url); if (u.hostname.includes("youtu.be")) { return u.pathname.replace("/", ""); } if (u.searchParams.get("v")) return u.searchParams.get("v"); // Shorts oder embed const parts = u.pathname.split("/").filter(Boolean); const idx = parts.findIndex((p) => p === "shorts" || p === "embed"); if (idx !== -1 && parts[idx + 1]) return parts[idx + 1]; return ""; } catch { // vielleicht hat der User nur die ID eingetippt return url.length >= 8 ? url : ""; } }

function prettyBytes(bytes) { if (bytes === 0) return "0 B"; const k = 1024; const units = ["B", "KB", "MB", "GB", "TB"]; const i = Math.floor(Math.log(bytes) / Math.log(k)); return ${(bytes / Math.pow(k, i)).toFixed(1)} ${units[i]}; }

function useJournalState() { const [data, setData] = useState(() => loadJSON(LS_KEY, { days: Array.from({ length: DAYS }, (_, i) => ({ day: i + 1, videoUrl: "", notes: "", done: false, updatedAt: Date.now(), })), createdAt: Date.now(), updatedAt: Date.now(), history: [], // z.B. fÃ¼r Streak/Ã„nderungen }) );

useEffect(() => { saveJSON(LS_KEY, data); }, [data]);

return [data, setData]; }

function useFilesMeta() { const [meta, setMeta] = useState(() => loadJSON(LS_META, {})); useEffect(() => saveJSON(LS_META, meta), [meta]); return [meta, setMeta]; }

function AccessGate({ children }) { const [ok, setOk] = React.useState(() => localStorage.getItem("journal21:access") === "yes"); const [input, setInput] = React.useState("");

React.useEffect(() => { const url = new URL(window.location.href); const token = url.searchParams.get("token"); if (token && token.length > 5) { localStorage.setItem("journal21:token", token); localStorage.setItem("journal21:access", "yes"); setOk(true); } }, []);

function handleSubmit(e) { e.preventDefault(); const VALID = ["ICHBINGENUG21", "TEST123", "GAST"]; // Platzhalter if (VALID.includes(input.trim())) { localStorage.setItem("journal21:access", "yes"); setOk(true); } else { alert("Falscher Zugangscode. Bitte prÃ¼fe deine BestellbestÃ¤tigung."); } }

if (ok) return children; return ( <AccessGate>

<div className="min-h-screen grid place-items-center bg-gradient-to-br from-zinc-50 to-zinc-100 p-6">
  <div className="max-w-md w-full bg-white/90 backdrop-blur border rounded-2xl shadow-sm p-6">
    <h2 className="text-xl font-semibold">GeschÃ¼tzter Bereich</h2>
    <p className="text-sm text-zinc-600 mt-1">Bitte gib deinen Zugangscode ein. Du erhÃ¤ltst ihn nach dem Kauf.</p>
    <form onSubmit={handleSubmit} className="mt-4 flex gap-2">
      <Input value={input} onChange={(e)=>setInput(e.target.value)} placeholder="Zugangscode"/>
      <Button type="submit">Ã–ffnen</Button>
    </form>
    <p className="text-xs text-zinc-500 mt-3">Tipp: Du kannst auch einen Link mit <code>?token=DEINCODE</code> versenden.</p>
  </div>
</div>

); }

export default function App() { const [data, setData] = useJournalState(); const [filesMeta, setFilesMeta] = useFilesMeta(); const [query, setQuery] = useState(""); const fileInputRef = useRef(null);

const completed = data.days.filter((d) => d.done).length; const progress = Math.round((completed / DAYS) * 100);

const streak = useMemo(() => { // einfacher Streak: wie viele Tage am StÃ¼ck (ab Tag 1) als done markiert let count = 0; for (let i = 0; i < DAYS; i++) { if (data.days[i].done) count++; else break; } return count; }, [data.days]);

const filteredDays = useMemo(() => { if (!query.trim()) return data.days; const q = query.toLowerCase(); return data.days.filter((d) => (d.notes || "").toLowerCase().includes(q) || (d.videoUrl || "").toLowerCase().includes(q) ); }, [data.days, query]);

function updateDay(idx, patch) { setData((prev) => { const next = { ...prev, days: [...prev.days] }; next.days[idx] = { ...next.days[idx], ...patch, updatedAt: Date.now() }; next.updatedAt = Date.now(); return next; }); }

async function handleFileUpload(dayIndex, files) { if (!files || !files.length) return; const fileList = Array.from(files); const now = Date.now();

const metas = [...(filesMeta[dayIndex + 1] || [])];

for (const f of fileList) {
  const id = `${now}-${Math.random().toString(36).slice(2, 8)}`;
  // Blob direkt in IndexedDB speichern
  await idb.set(`file:${id}`, f);
  metas.push({ id, name: f.name, size: f.size, type: f.type, ts: now });
}

setFilesMeta((prev) => ({ ...prev, [dayIndex + 1]: metas }));

}

async function handleFileOpen(id) { const blob = await idb.get(file:${id}); if (!blob) return alert("Datei nicht gefunden (wurde evtl. bereits gelÃ¶scht)."); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = ""; // Browser entscheidet (oder Nutzer) a.target = "_blank"; a.click(); setTimeout(() => URL.revokeObjectURL(url), 5000); }

async function handleFileDelete(dayIndex, id) { await idb.del(file:${id}); setFilesMeta((prev) => ({ ...prev, [dayIndex + 1]: (prev[dayIndex + 1] || []).filter((m) => m.id !== id), })); }

function resetAll() { if (!confirm("Wirklich alles zurÃ¼cksetzen? (Daten & Dateiverweise â€“ Dateien in IndexedDB bleiben bestehen)")) return; localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_META); window.location.reload(); }

async function exportAll(includeFiles = false) { const payload = { data, filesMeta };

if (includeFiles) {
  // Dateien als Base64 exportieren (kann groÃŸ werden)
  const files = {};
  for (const [dayStr, metas] of Object.entries(filesMeta)) {
    for (const m of metas) {
      const blob = await idb.get(`file:${m.id}`);
      if (!blob) continue;
      const b64 = await blobToBase64(blob);
      files[m.id] = { meta: m, base64: b64 };
    }
  }
  payload["filesBase64"] = files;
}

const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = includeFiles ? `journal21_backup_with_files_${Date.now()}.json` : `journal21_backup_${Date.now()}.json`;
a.click();
setTimeout(() => URL.revokeObjectURL(url), 5000);

}

async function importAll(file) { try { const text = await file.text(); const obj = JSON.parse(text); if (obj.data) setData(obj.data); if (obj.filesMeta) setFilesMeta(obj.filesMeta); if (obj.filesBase64) { for (const [id, fobj] of Object.entries(obj.filesBase64)) { const blob = base64ToBlob(fobj.base64, fobj.meta?.type || "application/octet-stream"); await idb.set(file:${id}, blob); } } alert("Import abgeschlossen."); } catch (e) { console.error(e); alert("Import fehlgeschlagen. UngÃ¼ltige Datei?"); } }

return ( <div className="min-h-screen bg-gradient-to-br from-zinc-50 to-zinc-100 text-zinc-800 p-4 md:p-8"> <header className="max-w-6xl mx-auto mb-6 md:mb-8"> <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4"> <div> <h1 className="text-2xl md:text-4xl font-semibold tracking-tight">21â€‘Tageâ€‘Journal</h1> <p className="text-sm md:text-base text-zinc-600 mt-1">YouTube einbetten Â· Fortschritt tracken Â· Dateien hochladen (lokal gespeichert)</p> </div> <div className="flex flex-wrap gap-2 items-center"> <Button variant="secondary" onClick={() => exportAll(false)} title="Nur Textdaten exportieren"> <Save className="h-4 w-4 mr-2"/> Export </Button> <Button variant="secondary" onClick={() => exportAll(true)} title="Mit Dateien (Base64) exportieren â€“ kann groÃŸ werden"> <Download className="h-4 w-4 mr-2"/> Export + Dateien </Button> <label className="inline-flex items-center"> <input type="file" accept="application/json" className="hidden" ref={fileInputRef} onChange={(e) => e.target.files && importAll(e.target.files[0])} /> <Button variant="secondary" onClick={() => fileInputRef.current?.click()}> <Import className="h-4 w-4 mr-2"/> Import </Button> </label> <Button variant="destructive" onClick={resetAll}> <RefreshCw className="h-4 w-4 mr-2"/> Reset </Button> </div> </div>

<div className="mt-4 md:mt-6">
      <div className="flex items-center justify-between mb-2">
        <span className="text-sm text-zinc-600">Fortschritt: {completed}/{DAYS} Tage</span>
        <span className="text-sm text-zinc-600">Streak: {streak} ðŸ”¥</span>
      </div>
      <Progress value={progress} className="h-3" />
    </div>

    <div className="mt-4 flex items-center gap-2">
      <div className="relative flex-1">
        <Search className="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400"/>
        <Input
          placeholder="Suche in Notizen & Linksâ€¦"
          className="pl-9"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
        />
      </div>
    </div>
  </header>

  <main className="max-w-6xl mx-auto grid md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 pb-16">
    {filteredDays.map((d) => {
      const idx = d.day - 1;
      const ytid = extractYouTubeId(d.videoUrl);
      const fmeta = filesMeta[d.day] || [];
      return (
        <motion.div key={d.day} initial={{ opacity: 0, y: 12 }} animate={{ opacity: 1, y: 0 }}>
          <Card className={`rounded-2xl shadow-sm ${d.done ? "border-emerald-300" : ""}`}>
            <CardContent className="p-4 md:p-5">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">Tag {d.day}</div>
                <label className="flex items-center gap-2 text-sm cursor-pointer select-none">
                  <input
                    type="checkbox"
                    checked={d.done}
                    onChange={(e) => updateDay(idx, { done: e.target.checked })}
                    className="h-4 w-4"
                  />
                  Erledigt
                </label>
              </div>

              <div className="space-y-3">
                <div>
                  <label className="text-xs text-zinc-500">YouTubeâ€‘URL oder Videoâ€‘ID</label>
                  <div className="flex gap-2 mt-1">
                    <Input
                      value={d.videoUrl}
                      onChange={(e) => updateDay(idx, { videoUrl: e.target.value })}
                      placeholder="https://youtu.be/â€¦ oder ID eingeben"
                    />
                    <Button variant="outline" onClick={() => {
                      if (!d.videoUrl) return;
                      const id = extractYouTubeId(d.videoUrl);
                      if (!id) return alert("Konnte keine Video-ID finden.");
                      updateDay(idx, { videoUrl: `https://www.youtube.com/watch?v=${id}` });
                    }} title="Link bereinigen">
                      <PlayCircle className="h-4 w-4"/>
                    </Button>
                  </div>
                  {ytid ? (
                    <div className="mt-3 aspect-video rounded-xl overflow-hidden border">
                      <iframe
                        className="w-full h-full"
                        src={`https://www.youtube.com/embed/${ytid}`}
                        title={`Tag ${d.day} Video`}
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowFullScreen
                      />
                    </div>
                  ) : null}
                </div>

                <div>
                  <label className="text-xs text-zinc-500">Notizen</label>
                  <Textarea
                    value={d.notes}
                    onChange={(e) => updateDay(idx, { notes: e.target.value })}
                    placeholder="Schreibe deine Erkenntnisse, Aufgaben oder Affirmationenâ€¦"
                    className="mt-1 min-h-[100px]"
                  />
                </div>

                <div>
                  <label className="text-xs text-zinc-500">Dateien hochladen</label>
                  <div className="mt-1 flex items-center gap-2">
                    <input
                      id={`file-${d.day}`}
                      type="file"
                      multiple
                      className="hidden"
                      onChange={(e) => handleFileUpload(idx, e.target.files)}
                    />
                    <label htmlFor={`file-${d.day}`}>
                      <Button variant="outline" className="gap-2">
                        <Upload className="h-4 w-4"/> Dateien auswÃ¤hlen
                      </Button>
                    </label>
                    <span className="text-xs text-zinc-500">{fmeta.length} Dateien</span>
                  </div>

                  {fmeta.length > 0 && (
                    <ul className="mt-3 space-y-2">
                      {fmeta.map((m) => (
                        <li key={m.id} className="flex items-center justify-between gap-2 text-sm bg-zinc-50 border rounded-lg p-2">
                          <div className="flex items-center gap-2 min-w-0">
                            <FileIcon className="h-4 w-4 shrink-0"/>
                            <div className="truncate">
                              <div className="truncate">{m.name}</div>
                              <div className="text-xs text-zinc-500">{prettyBytes(m.size)} Â· {new Date(m.ts).toLocaleString()}</div>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <Button size="sm" variant="secondary" onClick={() => handleFileOpen(m.id)} className="h-8">
                              <Download className="h-4 w-4 mr-1"/> Ã–ffnen
                            </Button>
                            <Button size="sm" variant="destructive" onClick={() => handleFileDelete(idx, m.id)} className="h-8">
                              <Trash2 className="h-4 w-4"/>
                            </Button>
                          </div>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        </motion.div>
      );
    })}
  </main>

  <footer className="fixed bottom-3 left-0 right-0 flex justify-center">
    <div className="px-3 py-2 bg-white/80 backdrop-blur border rounded-full shadow-sm text-xs text-zinc-600">
      Deine Daten bleiben lokal in deinem Browser. FÃ¼r Cloudâ€‘Sync spÃ¤ter: Supabase/Firebase hinzufÃ¼gen.
    </div>
  </footer>
</div>
</AccessGate>

); }

// ====== Helpers (unchanged) ====== function blobToBase64(blob) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result.split(",")[1]); reader.onerror = reject; reader.readAsDataURL(blob); }); }

function base64ToBlob(b64, mime = "application/octet-stream") { const byteChars = atob(b64); const byteNumbers = new Array(byteChars.length); for (let i = 0; i < byteChars.length; i++) { byteNumbers[i] = byteChars.charCodeAt(i); } const byteArray = new Uint8Array(byteNumbers); return new Blob([byteArray], { type: mime }); }

